# ABUILD generated by mkpkg_generator.sh

pkgname=git
pkgver=1.7.6
pkgbuild=1
arch=("auto")

shortdesc=("git (the stupid content tracker)")
longdesc=("Git is a fast, scalable, distributed revision control system with an unusually rich command set that provides both high-level operations and full access to internals. "git" can mean anything, depending on your mood. Git was originally written by Linus Torvalds and is currently maintained by Junio C. Hamano.")

tags=("dev-util develop")

source=("http://kernel.org/pub/software/scm/git/git-${pkgver}.tar.bz2")

config_files="etc/conf.d/git-daemon"
# Need to check if GIT is already installed.
if ls /usr/bin/git 1> /dev/null 2> /dev/null ; then
	echo "Git is installed.  The package should be removed before"
	echo "building, or the new package might be missing some"
	echo "perl modules."
	echo
	exit 1
fi


build() {
	go_src_dir
	burn_patches
	set -e

	eval $(perl '-V:installvendorlib')
	PERLDIR=$installvendorlib/$ARCH-linux-thread-multi/auto

	make prefix=/usr mandir=/usr/man "CFLAGS=$SLKCFLAGS" INSTALLDIRS=vendor ASCIIDOC8=YesPlease all doc -j${numjobs}
	make prefix=/usr mandir=/usr/man "CFLAGS=$SLKCFLAGS" INSTALLDIRS=vendor ASCIIDOC8=YesPlease NO_CROSS_DIRECTORY_HARDLINKS=1 DESTDIR=${pkgdir} install install-doc

	# Contrib
	mkdir -p $pkgdir/etc/bash_completion.d/
	install -m644 ./contrib/completion/git-completion.bash $pkgdir/etc/bash_completion.d/git
	cp -a ./contrib $pkgdir/usr/share/git/

	# Fix bash-completion script
	( cd ${pkgdir}/etc/bash_completion.d ; cat ${filedir}/git-completion.patch | patch -p0 )


	# Emacs intergation
	mkdir -p $pkgdir/usr/share/emacs/site-lisp
	mv $pkgdir/usr/share/git/emacs $pkgdir/usr/share/emacs/site-lisp/git
	rm $pkgdir/usr/share/emacs/site-lisp/git/.gitignore

	# Switch a hard link with a soft link:
	( cd ${pkgdir}/usr/bin
	find . -links +1 -not -name git | while read gitfile ; do
		if [ git -ef $gitfile ]; then
			rm -vf $gitfile
			ln -vfs git $gitfile
		fi
	done
	)

	# remove perllocal.pod, .packlist, and empty directories.
	rm -rf $pkgdir/usr/lib${LIBDIRSUFFIX}/perl5
	
	# Directory for daemon
	mkdir -p ${pkgdir}/var/git
	chown nobody:nobody ${pkgdir}/var/git

	# OpenRC
	mkdir -p ${pkgdir}/etc/{conf.d,init.d}
	install -m755 ${filedir}/git-daemon.initd ${pkgdir}/etc/init.d/git-daemon
	install -m644 ${filedir}/git-daemon.confd ${pkgdir}/etc/conf.d/git-daemon

	set +e

}
