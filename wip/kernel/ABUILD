# ABUILD generated by mkpkg_generator.sh

pkgname=kernel
# Kernel version may contain '-' symbol, so let's protect from it by using kernel_ver everywhere.
pkgver=3.3.0

kernel_ver=`echo $pkgver | sed -e s/_/-/g`
if [ "$kernel_ver" = "`echo $kernel_ver | sed 's/\.0$//g'`" ] ; then
	srcver=$kernel_ver
else 
	srcver=`echo $kernel_ver | sed 's/\.0$//g'`
fi
kernel_base=`echo $kernel_ver | sed 's/^[^.]*\.//' | sed 's/\..*$//'`

pkgbuild=1
arch=("auto")

shortdesc=("Linux kernel")
longdesc=("This is a Linux kernel with built-in support for most disk controllers and filesystems.")

tags=("base sys-kernel")
adddep="kernel-modules==$pkgver kernel-firmware"

source=("ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-${srcver}.tar.xz")

custom_opts="skip_gendeps no_strip skip_validate"

skip_gendeps=1

pkglist=("modules headers firmware sources")

modules() {
	pkgname=kernel-modules
	arch=("auto")
	shortdesc=('SMP Linux kernel modules for generic kernel')
	longdesc=('A kernel module is a piece of object code that can be dynamically loaded into the Linux kernel to provide new kernel functions. Most of these modules provide support for devices such as CD-ROM drives, tape drives, and ethernet cards. You can choose which modules to load by editing /etc/conf.d/modules.')

	tags=('base sys-kernel')
	adddep="kmod kernel==$pkgver"
}

headers() {
	pkgname=kernel-headers
	arch=("auto")
	shortdesc=('kernel-headers (Linux kernel include files)')
	longdesc=('These are the include files from the Linux kernel. You will need these to compile most system software for Linux.')

	tags=('develop sys-kernel')
}

firmware() {
	pkgname=kernel-firmware
	arch=("fw")
	shortdesc=('kernel-firmware (Firmware installed by the kernel)')
	longdesc=('These are the firmware files from the Linux kernel. You will need these to use certain hardware with Linux.')

	tags=('base sys-kernel')
}

sources() {
	pkgname=kernel-source
	arch=('auto')
	shortdesc=('kernel-source (Linux kernel source)')
	longdesc=('Source code for Linus Torvalds Linux kernel. This is the complete source code for the Linux kernel.')

	tags=('develop sys-kernel')
}

build() {
	go_src_dir
	burn_patches

	cp $filedir/defconfig$LIBDIRSUFFIX .config

	make oldconfig
	make -j${numjobs}
}

after_build() {
	go_src_dir
	mkdir -p ${pkgdir}/boot
	cp arch/x86/boot/bzImage ${pkgdir}/boot/vmlinuz-${kernel_ver}
	ln -s vmlinuz-${kernel_ver} $pkgdir/boot/vmlinuz
	cp System.map $pkgdir/boot/System.map-${kernel_ver}
	ln -s System.map-${kernel_ver} $pkgdir/boot/System.map
	cp .config $pkgdir/boot/config-${kernel_ver}
	ln -s config-${kernel_ver} $pkgdir/boot/config
}

modules_prep() {
	go_src_dir
	make modules_install INSTALL_MOD_PATH=${pkgdir}

	# Remove firmware from modules package. I don't know why it installs together with modules...
	rm -rf ${pkgdir}/lib/firmware
	rm ${pkgdir}/lib/modules/$pkgver/{source,build}
	ln -sf /usr/src/linux-${kernel_ver} ${pkgdir}/lib/modules/${kernel_ver}/source
	ln -sf /usr/src/linux-${kernel_ver} ${pkgdir}/lib/modules/${kernel_ver}/build
}

headers_prep() {
	go_src_dir
	make headers_install INSTALL_HDR_PATH=${pkgdir}/usr
	find $pkgdir/usr/include -name '.install' | xargs rm
	find $pkgdir/usr/include -name '..install.cmd' | xargs rm
}

firmware_prep() {
	go_src_dir
	make firmware_install INSTALL_FW_PATH=${pkgdir}/lib/firmware
	cp -a firmware/WHENCE ${pkgdir}/lib/firmware
}

sources_prep() {
	go_src_dir
	mkdir -p $pkgdir/usr/src/linux-${kernel_ver}
	echo "Copying kernel tree, please wait. It may take about 10 minutes"
	cp -ard ./* $pkgdir/usr/src/linux-${kernel_ver}/
	( cd $pkgdir/usr/src/linux-${kernel_ver} && make mrproper )
	cat .config > $pkgdir/usr/src/linux-${kernel_ver}/.config
	( cd $pkgdir/usr/src/linux-${kernel_ver} && make prepare && make modules_prepare )
	( cd $pkgdir/usr/src ; ln -s linux-$kernel_ver linux )
}
