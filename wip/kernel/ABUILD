# ABUILD generated by mkpkg_generator.sh
pkgname=kernel
pkgver=3.3.0
pkgbuild=1
arch=("auto")

shortdesc=("Linux kernel")
longdesc=("This is a Linux kernel with built-in support for most disk controllers and filesystems.")

tags=("base sys-kernel")
adddep="kernel-modules==$pkgver kernel-firmware"

source=("ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-${pkgver/.0\$/}.tar.xz")

custom_opts="skip_gendeps no_strip skip_validate"

pkglist=("modules headers sources")

modules() {
	pkgname=kernel-modules
	arch=("auto")
	shortdesc=('SMP Linux kernel modules for generic kernel')
	longdesc=('A kernel module is a piece of object code that can be dynamically loaded into the Linux kernel to provide new kernel functions. Most of these modules provide support for devices such as CD-ROM drives, tape drives, and ethernet cards. You can choose which modules to load by editing /etc/conf.d/modules.')

	tags=('base sys-kernel')
	adddep="kmod kernel==$pkgver"
}

headers() {
	pkgname=kernel-headers
	arch=("auto")
	shortdesc=('kernel-headers (Linux kernel include files)')
	longdesc=('These are the include files from the Linux kernel. You will need these to compile most system software for Linux.')

	tags=('develop sys-kernel')
}

sources() {
	pkgname=kernel-source
	arch=('auto')
	shortdesc=('kernel-source (Linux kernel source)')
	longdesc=('Source code for Linus Torvalds Linux kernel. This is the complete source code for the Linux kernel.')

	tags=('develop sys-kernel')
}

build() {
	go_src_dir
	burn_patches
	cp $filedir/defconfig$LIBDIRSUFFIX .config
	make oldconfig
	make -j${numjobs}
}

after_build() {
	go_src_dir
	mkdir -p ${pkgdir}/boot
	cp arch/x86/boot/bzImage ${pkgdir}/boot/vmlinuz-$pkgver
	ln -s vmlinuz-$pkgver $pkgdir/boot/vmlinuz
	cp System.map $pkgdir/boot/System.map-$pkgver
	ln -s System.map-$pkgver $pkgdir/boot/System.map
}

modules_prep() {
	go_src_dir
	make modules_install INSTALL_MOD_PATH=${pkgdir}
	rm -rf ${pkgdir}/lib/firmware
	rm ${pkgdir}/lib/modules/$pkgver/{source,build}
	ln -sf /usr/src/linux-$pkgver ${pkgdir}/lib/modules/$pkgver/source
	ln -sf /usr/src/linux-$pkgver ${pkgdir}/lib/modules/$pkgver/build
}

headers_prep() {
	go_src_dir
	make headers_install INSTALL_HDR_PATH=${pkgdir}/usr
	find $pkgdir/usr/include -name '.install' | xargs rm
	find $pkgdir/usr/include -name '..install.cmd' | xargs rm
}

sources_prep() {
	go_src_dir
    make mrproper
	mkdir -p $pkgdir/usr/src/linux-$pkgver
	cp -ard * $pkgdir/usr/src/linux-$pkgver
    cd $pkgdir/usr/src
    ln -s linux-$pkgver linux
}
