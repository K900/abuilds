pkgname=mozilla-firefox
pkgver=7.0.1
_pkgver=$pkgver
pkgbuild=1
arch=('any')

shortdesc="Mozilla-firefox web browser"

source=("ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/${pkgver}/source/firefox-${pkgver}.source.tar.bz2"
"ftp://ftp.mozilla.org/pub/firefox/releases/${pkgver}/linux-i686/xpi/ru.xpi n o"
"ftp://ftp.mozilla.org/pub/firefox/releases/${pkgver}/linux-i686/xpi/uk.xpi n o")

tags="xapps www-client"

numjobs=1

pkglist="dev xulrunner"

dev() {
	pkgname=mozilla-firefox-dev
	shortdesc="Development files and headers for Mozilla Firefox"
}

xulrunner() {
	pkgname=xulrunner
	shortdesc="XULRunner SDK from Mozilla"
}

before_build()
{
	go_src_dir
	# Kill @PRE_RELEASE_SUFFIX@ from browser.xul because it
	# gets set to \177 for an unknown reason
	sed -i 's/@PRE_RELEASE_SUFFIX@//g' browser/base/content/browser.xul || exit 1
}

build() 
{
	go_src_dir
	burn_patches

	sed "${filedir}/mozconfig" -e "s,%%LIBDIR%%,${LIBDIRSUFFIX},g" > ".mozconfig"
	export LDFLAGS="-Wl,-rpath,/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver} -Wl,-O1,--sort-common,--hash-style=gnu,--as-needed"
	export PYTHON="/usr/bin/python"

	make -j1 -f client.mk build MOZ_MAKE_FLAGS="-j$numjobs"
	unset MOZ_MAKE_FLAGS
	make -j1 -f client.mk DESTDIR=${pkgdir} install
}

after_build()
{
	go_src_dir
	for i in 16x16 22x22 24x24 32x32 48x48 256x256; do
		 install -Dm644 browser/branding/official/default${i/x*/}.png ${pkgdir}/usr/share/icons/hicolor/$i/apps/firefox.png
	done
                  
	_langs="ru uk"
	for _lang in ${_langs}; do
		install -m644 ${srcache}/${_lang}.xpi ${pkgdir}/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver}/extensions/langpack-${_lang}@firefox.mozilla.org.xpi || exit 1
	done

	rm -rf ${pkgdir}/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver}/searchplugins
	cp -a ${filedir}/searchplugins /${pkgdir}/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver}

	cd ${pkgdir}/usr/bin
       	rm -rf firefox
	ln -sf ../lib${LIBDIRSUFFIX}/firefox-${_pkgver}/firefox firefox

	cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
       	rm -rf firefox
	ln -sf firefox-${_pkgver} firefox

	# Use system hunspell
	rm -rf ${pkgdir}/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver}/{dictionaries,hyphenation}
	ln -sf /usr/share/hunspell ${pkgdir}/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver}/dictionaries
	ln -sf /usr/share/hyphen ${pkgdir}/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver}/hyphenation
}

dev_prep() {
	mkdir -p $pkgdir/usr/{include,lib$LIBDIRSUFFIX/firefox-devel-$_pkgver,share/idl}
	mv $p_pkgdir/usr/include/* $pkgdir/usr/include/
	mv $p_pkgdir/usr/lib$LIBDIRSUFFIX/firefox-devel-$_pkgver/* $pkgdir/usr/lib$LIBDIRSUFFIX/firefox-devel-$_pkgver/
	mv $p_pkgdir/usr/share/idl/* $pkgdir/usr/share/idl/
}

xulrunner_prep() {
	go_src_dir
	
	sed "${filedir}/mozconfig-xulrunner" -e "s,%%LIBDIR%%,${LIBDIRSUFFIX},g" > ".mozconfig"
	export LDFLAGS="-Wl,-rpath,/usr/lib${LIBDIRSUFFIX}/firefox-${_pkgver} -Wl,-O1,--sort-common,--hash-style=gnu,--as-needed"
	export PYTHON="/usr/bin/python"

	make -j1 -f client.mk build MOZ_MAKE_FLAGS="-j$numjobs"
	unset MOZ_MAKE_FLAGS
	make -j1 -f client.mk DESTDIR=${pkgdir} install
}
