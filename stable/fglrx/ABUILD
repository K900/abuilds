#ABUILD created by/создан: SirAnthony, anthony at adsorbtion.org 
pkgname=fglrx
pkgver=11.9
pkgbasever=${pkgver}
srcver=$(echo $pkgver | sed "s/\./-/g")
mesaver=7.10
kernelver=$(uname -r)
pkgbuild=1
pkgbasebuild=${pkgbuild}
arch=('auto')

shortdesc="Server X Driver for ATI proprietary driver"

source="http://www2.ati.com/drivers/linux/ati-driver-installer-$srcver-x86.x86_64.run"

tags="proprietary x11-drivers drivers"

adddep="fglrx-module=${pkgver} libglx libgl mesa xorg-server"
removedep="libgl"

pkglist="fglrx-module libgl_fglrx libglx_fglrx"

fglrx-module() {
    pkgname=fglrx-module
    shortdesc="The module of kernel for the ATI proprietary driver"
    adddep="kernel=${kernelver} fglrx=${pkgbasever}"
    pkgver=${pkgbasever}
    pkgbuild=${kernelver}_${pkgbasebuild}
}

libglx_fglrx() {
    shortdesc="libglx from fglrx driver. Replaces xorg-based libglx package for ati users"
    adddep="fglrx=${pkgbasever}"
    pkgver=${mesaver}
    pkgbuild=${pkgbasever}_${pkgbasebuild}
    pkgname=libglx-fglrx
#    provides=libglx
}

libgl_fglrx() {
    pkgname=libgl-fglrx
    shortdesc="libGL from fglrx driver. Replaces mesa-based libgl package for ari users"  
    provides=libgl
    adddep="fglrx=${pkgbasever}"
    pkgver=${mesaver}
    pkgbuild=${pkgbasever}_${pkgbasebuild}
}

build()
{
    go_src_dir
    #not work with ccache
    sh $srcache/ati-driver-installer-${srcver}-x86.x86_64.run --extract ati-driver
    cd ati-driver
    burn_patches
    CC="gcc" CCX="g++" ./ati-installer.sh $pkgver --buildpkg Slackware/Slackware
}

after_build()
{
    go_src_dir
    tar -C ${pkgdir} -kxvf ${srcdir}/fglrx-*.tgz

    # Base
    mkdir -p ${pkgdir}/usr/lib${LIBDIRSUFFIX}/dri
    cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}/dri
    ln -sf ../xorg/modules/dri/fglrx_dri.so fglrx_dri.so
    cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
    ln -sf libatiuki.so.1.0 libatiuki.so.1
    ln -sf libatiuki.so.1 libatiuki.so
    ln -sf libfglrx_dm.so.1.0 libfglrx_dm.so.1
    ln -sf libfglrx_dm.so.1 libfglrx_dm.so
    ln -sf libXvBAW.so.1.0 libXvBAW.so.1
    ln -sf libXvBAW.so.1 libXvBAW.so
    ln -sf libAMDXvBA.so.1.0 libAMDXvBA.so.1
    ln -sf libAMDXvBA.so.1 libAMDXvBA.so

    mkdir -p ${startdir}/libgl-fglrx/usr/lib${LIBDIRSUFFIX}
    mkdir -p ${startdir}/libglx-fglrx/usr/lib${LIBDIRSUFFIX}/xorg/modules/extensions/fglrx
    mv $pkgdir/usr/lib${LIBDIRSUFFIX}/*libGL.* $pkgdir/usr/lib${LIBDIRSUFFIX}/fglrx/ \
        $startdir/libgl-fglrx/usr/lib${LIBDIRSUFFIX}
    mv $pkgdir/usr/lib${LIBDIRSUFFIX}/xorg/modules/extensions/*libglx.* \
        $startdir/libglx-fglrx/usr/lib${LIBDIRSUFFIX}/xorg/modules/extensions/fglrx/

    # libGL
    # 3 одинаковых файла, заменил все симлинками
    cd $startdir/libgl-fglrx/usr/lib${LIBDIRSUFFIX}
    ( cd fglrx/
        rm -f libGL.so.1.2
        ln -sf fglrx-libGL.so.1.2 libGL.so.1.2
    )
    ln -sf fglrx/fglrx-libGL.so.1.2 libGL.so.1.2
    ln -sf libGL.so.1.2 libGL.so.1
    ln -sf libGL.so.1 libGL.so
    rm -f fglrx-libGL.so.1.2
    ln -sf fglrx/fglrx-libGL.so.1.2 fglrx-libGL.so.1.2
    ln -sf fglrx-libGL.so.1.2 fglrx-libGL.so.1
    ln -sf fglrx-libGL.so.1 fglrx-libGL.so


    # libglx
    cd $startdir/libglx-fglrx/usr/lib${LIBDIRSUFFIX}/xorg/modules/extensions/fglrx
    ln -sf fglrx-libglx.so libglx.so
    cd ..
    ln -sf fglrx/fglrx-libglx.so fglrx-libglx.so
    ln -sf fglrx/fglrx-libglx.so libglx.so

    mv ${pkgdir}/lib  $startdir/fglrx-module/
}
